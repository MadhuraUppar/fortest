name: Stages Creation Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        description: "environment"
        options:
          - "Dev"
          - "QA"
          - "PROD"

  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  MY_GLOBAL_VARIABLE: 'old_value'

jobs:
  changed_files_list:
    runs-on: ubuntu-latest
    outputs:
      job1_completed: ${{ steps.set-changed-files.outputs.job1_completed }}
    if: github.event_name == 'pull_request'
    steps:
      - name: Clone Repo
        uses: actions/checkout@v3

      - name: Get main branch
        run: git fetch --no-tags --prune --depth=1 origin +refs/heads/${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Get list of changed files in a specific directory
        id: set-changed-files
        run: echo "changedfiles=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.event.pull_request.base.ref }} HEAD | grep '^snowflake_stages_automation' | uniq)" >> $GITHUB_OUTPUT

      - name: Print files to be validated in first_workflow
        run: echo "${{ steps.set-changed-files.outputs.changedfiles }}"

      - name: Set job1_completed output
        id: set-job1-completed
        run: |
          if [ -z "${{ steps.set-changed-files.outputs.changedfiles }}" ]; then
            echo "::set-output name=job1_completed::false"
          else
            echo "::set-output name=job1_completed::true"
          fi

  dev_stages_workflow:
    runs-on: windows-latest
    needs: changed_files_list
    steps:
      - name: Print files to be validated in dev_stage
        run: echo ${{ needs.changed_files_list.result }}
